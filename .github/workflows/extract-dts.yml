name: Extract DTS from lk2nd (rolex)

on:
  workflow_dispatch:

jobs:
  extract-dts:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y device-tree-compiler binwalk

      - name: Download lk2nd image
        run: |
          mkdir work
          cd work
          wget -O lk2nd.img \
            https://github.com/aksSuzumiya6666/redmi-4a-rolex-linux/releases/download/20240816/lk2nd-redmi4a.img

      - name: Extract DTBs using known offsets
        run: |
          cd work
          mkdir -p dtb

          # Small DTBs
          dd if=lk2nd.img of=dtb/dtb_223a7.dtb bs=1 skip=140199 count=434
          dd if=lk2nd.img of=dtb/dtb_22559.dtb bs=1 skip=140633 count=1240
          dd if=lk2nd.img of=dtb/dtb_22a31.dtb bs=1 skip=141873 count=719
          dd if=lk2nd.img of=dtb/dtb_23800.dtb bs=1 skip=145408 count=1240
          dd if=lk2nd.img of=dtb/dtb_24000.dtb bs=1 skip=147456 count=434
          dd if=lk2nd.img of=dtb/dtb_24800.dtb bs=1 skip=149504 count=719

          ls -lh dtb

      - name: Convert DTB to DTS
        run: |
          cd work
          mkdir -p dts
          for f in dtb/*.dtb; do
            name=$(basename "$f" .dtb)
            dtc -I dtb -O dts "$f" -o "dts/$name.dts"
          done

      - name: Extract touchscreen configuration
        run: |
          cd work
          mkdir -p report
          grep -Rni \
            -e touchscreen \
            -e goodix \
            -e focaltech \
            -e ft5x \
            -e synaptics \
            dts > report/touchscreen.txt || true

      - name: Upload DTS files
        uses: actions/upload-artifact@v4
        with:
          name: dts-files
          path: work/dts

      - name: Upload touchscreen report
        uses: actions/upload-artifact@v4
        with:
          name: touchscreen-report
          path: work/report
          
