name: Extract DTS from lk2nd (Qualcomm DT)

on:
  workflow_dispatch:

jobs:
  extract-dts:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y \
            binwalk \
            device-tree-compiler \
            python3 \
            unzip

      - name: Download lk2nd image
        run: |
          mkdir work
          cd work
          wget -O lk2nd.img \
            https://github.com/aksSuzumiya6666/redmi-4a-rolex-linux/releases/download/20240816/lk2nd-redmi4a.img

      - name: Deep extract image (recursive)
        run: |
          cd work
          binwalk -eM lk2nd.img

      - name: Find all DTB files
        run: |
          cd work
          mkdir -p dtb
          find . -type f -name "*.dtb" -exec cp {} dtb/ \;

      - name: Convert DTB to DTS
        run: |
          cd work
          mkdir -p dts
          for f in dtb/*.dtb; do
            name=$(basename "$f" .dtb)
            dtc -I dtb -O dts "$f" -o "dts/$name.dts" || true
          done

      - name: Extract touchscreen nodes
        run: |
          cd work
          mkdir -p report
          grep -Rni \
            -e touchscreen \
            -e goodix \
            -e synaptics \
            -e ft5x \
            -e focaltech \
            dts > report/touchscreen.txt || true

      - name: Upload DTS
        uses: actions/upload-artifact@v4
        with:
          name: dts-files
          path: work/dts

      - name: Upload touchscreen report
        uses: actions/upload-artifact@v4
        with:
          name: touchscreen-report
          path: work/report
          
